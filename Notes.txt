@Aspect
@Component
public class MaskedAspect {

    @Around("execution(public String *.toString()) && @target(masked)")
    public Object maskToString(ProceedingJoinPoint joinPoint, Masked masked) throws Throwable {
        Object target = joinPoint.getTarget();
        Field[] fields = target.getClass().getDeclaredFields();

        for (Field field : fields) {
            if (field.isAnnotationPresent(Masked.class)) {
                Masked annotation = field.getAnnotation(Masked.class);
                field.setAccessible(true);
                Object value = field.get(target);
                if (value instanceof String) {
                    field.set(target, maskValue((String) value, annotation));
                }
            }
        }

        return joinPoint.proceed();
    }

    private String maskValue(String value, Masked annotation) {
        if (value == null) {
            return null;
        }

        int start = annotation.start();
        int end = annotation.end();
        char maskChar = annotation.maskChar();

        if (end < 0 || end >= value.length()) {
            end = value.length();
        }

        if (start < 0 || start >= end) {
            start = 0;
        }

        int length = end - start;
        String maskedValue = value.substring(0, start);
        maskedValue += String.valueOf(maskChar).repeat(Math.max(0, length));
        maskedValue += value.substring(end);

        return maskedValue;
    }
}